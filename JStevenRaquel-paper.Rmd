---
title: "Analyzing centralitty measures for a sexual network of gonorrhea transmission"
subtitle: "SOC 280 Fall 2021"
author: "J Steven Raquel"

mainfont: Times New Roman
sansfont: Times New Roman
output:
  pdf_document
geometry: "margin=1in"
fontsize: 12pt
csl: american-sociological-association.csl
header-includes:
  - \usepackage{setspace}

---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(sna)
library(igraph)
library(epimdr) # for gonnet data
library(CINNA) # for pca_centralities()
library(car) # for leveneTest()
library(factoextra) # for nbclust
library(kableExtra) # nicer tables
library(knitr) # kable
library(ergm) # ERGMS
library(coda)
library(statnet)
library(latticeExtra)
library(GGally) # ggnet2 
library(foreign)
library(ergm.userterms)
library(Matrix)
source(here::here("functions.R"))
```


\doublespacing

# Abstract

# Introduction

Contact tracing for sexually transmitted diseases (STDs) such as gonorrhea, chlamydia, syphilis etc. is a persistent epidemiological problem, as it depends on individuals getting routinely tested as well as informing their sexual partners of their positive diagnosis should they receive one. Compounding this with the fact that many of these positive cases can be symptomless but still contagious creates a serious issue. Gonorrhea in particular is a disease that can be asymptomatic in both men and women who have it, that can go so far as causing infertility or lead to a life-threatening condition.

This dataset, constructed in the form of an adjacency matrix, contains 89 nodes, one of which is the "event" of attending a bar (i.e. when a node has a tie with this bar node, it means they attend the bar). Two of these nodes (denoted by `x` and `x2`) are missing information about their gender which is otherwise indicated by an `m` or `f` in the label of the respective node, followed by a number with which to differentiate them.

The network is directed, and the criteria for some node $i$ to have a tie with some other node $j$ must be that that $i$th node named node $j$ as a prior sexual partner. 

The data was collected from a series of adjacent aboriginal communities located in the province of Alberta, Canada, where public health officials took note of a local gonorrhea outbreak and confirmed that attendance at a local bar in one such community was associated with infection (De 2003).

# Background

## Data Collection 

The sociometric approach for enumerating a sexual network entails an iterative process in which the subject names past sexual partners, who are them traced and interviewed to identify whether they are linked and also to identify other contacts in the network (Doherty 2005). Conversely, the egocentric approach bases the network entirely on the information volunteered by the original subject. 

There are a number of shortcomings that are inherent to mapping out a sexual network, the first being that the design suffers from incomplete-network bias when partners cannot be traced or recruited for a variety of reasons (Doherty 2005). For example, the contact tracing of sexual partners is relegated to those who have a positive test result, and since such individuals may have markedly different positions within a network, tracing a network consisting solely of STI-positive partners has an inherent bias.

For example, consider that the prevalence of STI infection has a high negative correlation with condom usage i.e. using condoms infrequently, or not at all, comes with a higher risk of contracting an STI. If we assume individuals who engage in this kind of risky behavior on a regular basis are more likely to test positive for an STI, then the mapping of our sexual network may predominantly include only those individuals who partake in this behavior to some degree, and their partners with whom they had safe sex with (or simply did not transmit an STI to) will go unrecorded.

There are some behavioral considerations taken into account when considering this data, as is inherent with studies in which data is based on information nominated directly from the subjects. In a sexual network such as this the information regarding past sexual partners is volunteered on the part of the individual who represents the node in the graph, and as such, it's subject to an individual possibly withholding information, or simply not having the information at all. For example, an individual may be reluctant to disclose the identity of a sexual partner if they are in a monogamous relationship and to disclose this event would mean owning up to infidelity, or perhaps if the sex was in exchange for money i.e. sex work. It could also be that the sex occurred in an anonymous context and they simply do not have the information on the individual.

There is a social stigma attached to promiscuity (having a high number of sexual partners), as well as living with an STI, so it's important to note that the data may be skewed by dishonesty on the part of the individuals comprising the dataset. For example, a person who receives a positive test result for a sexually transmitted disease may refrain from naming _all_ of their recent sexual partners, either to avoid having to communicate the uncomfortable truth of either having contracted or transmitted a disease, or to avoid judgment for divulging what may be perceived as a high number of sexual partners. Societal attitudes towards sex and sexual health both in a Western context and also in an indigenous/Aboriginal context can and should be kept in mind when drawing conclusions from this data.

Some of these biases could be mitigated if we had all of the complete information on infection/non-infection status and were able to recruit all members of a sexual network, but this is impractical, improbable, or even illegal in some areas. These biases are inherent to these types of models but these studies still are important in anticipating and modeling the spread of STIs due to the highly social component of transmission, compared to for example, the spread of influenza.

Wasserman and Faust (1994) define "cutpoints" and "bridges" as nodes and ties respectively that cause the graph in which they are contained to have less components if they were to be taken out from the graph. In other words, they are the nodes or ties that connect what would be otherwise unconnected sub-graphs. These are crucial in sexual network analysis because these nodes and ties are the difference between whether a certain network may propagate an STI outbreak or not. 

# Methods

# Results

# Discussion

# Conclusions

\singlespacing

```{r data-prep, echo = F}
# library(epimdr) is loaded
data(gonnet)
# data is loaded as 'gonnet'
nodes <- rownames(gonnet)
# indices where "x" and "x2 are
drop <- which(nodes %in% c("x", "x2"))
# drop rows/columns with these numbers
gonnet <- gonnet[-drop, -drop]
# symmetrized graph (undirected)
gonnet <- symmetrize(gonnet, rule = "weak")
nodes <- nodes[-drop]
rownames(gonnet) <- nodes
colnames(gonnet) <- nodes
# creating bar attendance vector
attended_bar <- gonnet["b", ] == 1
# creating gender vector
gender <- ifelse(grepl("m", nodes), yes = "M", no = NA)
gender <- ifelse(grepl("f", nodes), yes = "F", no = gender)

# dropping bar object from this network
gonnet_nobar <- gonnet[-1,]
gonnet_nobar <- gonnet_nobar[,-1]

# creating network object
gonnet_net_nobar <- network(gonnet_nobar, directed = F)

# adding bar attendance on graphs
network::set.vertex.attribute(gonnet_net_nobar, 'bar', attended_bar[-1])
# adding gender to the graph
network::set.vertex.attribute(gonnet_net_nobar, 'gender', gender[-1])

gonnet_bar <- gonnet
# creating igraph object
gonnet_bar_ig <- graph_from_adjacency_matrix(gonnet_bar)

(pc <- proper_centralities(gonnet_bar_ig)) %>% 
  capture.output() %>%
  invisible()

# calculating centralities for the connected graph
centralities <- calculate_centralities(gonnet_bar_ig, 
                       include = pc[c(1, 4, 11, 16, 27, 
                                      45, 8, 18, 31, 43, 3, 19)])



# we care about 
# closeness centrality, katz centrality, eigenvector centrality, avg distance, degree centrality, and information centrality
degree <- sna::degree(gonnet_bar, gmode = "graph")
cen <- data.frame(closeness = centralities$`Closeness Centrality (Freeman)`,
                  katz = centralities$`Katz Centrality (Katz Status Index)`,
                  eigenvector = centralities$`eigenvector centralities`,
                  avg_distance = centralities$`Average Distance`,
                  information = centralities$`Information Centrality`,
                  degree)

gonnet_df <- data.frame(
  nodes,
  attended_bar,
  gender,
  degree
)

# adding partners column to dataset
gonnet_df <- gonnet_df %>% 
  mutate(partners = ifelse(attended_bar == T, yes = degree - 1, no = degree))
gonnet_df$partners[gonnet_df$nodes == "b"] <- NA

# adding partners to vertex attributes
network::set.vertex.attribute(gonnet_net_nobar, 'partners', gonnet_df$partners[-1])

```

```{r network-objects, echo = F}

# creating a network object of the two-mode network with the bar
gonnet_net_bar <- network(gonnet_bar, directed = F)

# adding gender to the graph
network::set.vertex.attribute(gonnet_net_bar, 'gender', gender)
network::set.vertex.attribute(gonnet_net_bar, 'degree', degree)

# adding a linetype attribute so that the edges to the bar are dashed lines
edgelist <- as.matrix(gonnet_net_bar, matrix.type="edgelist")
network::set.edge.attribute(gonnet_net_bar, "lty", 
                            ifelse(edgelist[,2] == 1, 2, 1))

```


```{r sociogram-ggnet2-bar, echo = F, fig.cap = "The network with bar as a node."}
set.seed(62)
ggnet2(gonnet_net_bar,
       color = "gender", 
       palette = c("F" = "#F8766D", "M" = "#00BFC4", "NA" = "grey"),
       mode = "fruchtermanreingold",
       label = F,
       edge.lty = "lty", 
       size = 5)

```

\doublespacing

Looking at this initial sociogram, where the bar node is firmly in the center, we see that it has outgoing connections to 17 nodes, which themselves have connections to at least one other node in the rest of the network. 

The majority of ties are between individuals of the opposite sex, e.g. male-to-female or female-to-male, but there are a minority of instances where individuals have a tie to individuals of the same sex, e.g. `m112` has ties with both `m106` and `m107`, who both in turn have ties to at least one female node. 

The node `m010` is also unique in that it happens to have ties to one female node (`f024`) and one male node (`m018`), the latter of which in turn has a tie with a female node (`f023`). The idea of men who have sex with men (MSM) or women who have sex with women (WSW) acting as bridging nodes between otherwise disparate sexual networks was something considered in the exploratory analysis but there just wasn't enough data to delve deeper into this subject.

## Centrality 

\doublespacing

According to Borgatti and Everett (2006), _centrality_ is a summary index of a node's position in a graph, based on sums or averages of one of several things: 1) the number of edges the node has, 2) the length of the paths that end up at the node, or 3) the proportion of paths that contain the node inside of it (not as an endpoint).

Different measures of centrality depend on functions of one of these aspects and communicate different things about a node, depending on the algorithm for the centrality measure. In this paper, we're going to look different kinds of centrality as a means of quantifying the impact of individual nodes on the network.

### Principal Component Analysis

Principal component analysis is a method for drawing out important variables from a dataset and is used frequently when dimensionality reduction is necessary. 


```{r centralities_more, echo = F, include = F}
# plot of different centralities' contributions via PCA
pca_centralities(centralities)
```

### Degree Centrality

For an undirected network such as this, then the degree of some node $i$ is just the count of ties it has to other nodes. Supposing we had some adjacency matrix $A$, then the degree of node $i$ is equal to 

$$D_i = \sum_j a_{ij}$$
where $j$ is the number of nodes in the network and $a_{ij} = 1$ given that node $i$ has a tie with node $j$, and zero otherwise. Note that in this network those who attended the bar have a tie with the bar node to represent that relationship, hence in order to treat degree as a means of quantifying sexual partners, we added in an adjustment in the form of a new variable called `partners` which subtracts 1 from the degree of those bar attendees. 

As noted earlier in Figure 3, the largest component contains 2 nodes (`m017` and `f011`) with degrees of 6 and 7 respectively. Noting their respective positions in the network, we see that a high degree centrality doesn't necessarily imply a large impact on the network in general, as long as an ego's alters do not themselves have a high degree centrality. The converse is also true where an ego can have a small degree but still be connected to an alter than itself has a high degree, e.g. `f014` was a bar attendee with a degree of one, connecting itself to `m208` who accordingly has 4 other alters, some of whom have more among them. 

It's possible in fact for an ego to have a high degree but whose alters themselves have a very low degree, such that their respective sub-component is not very large, e.g. `f004` which has an outdegree of 5, but all of its alters have a degree of only 1 or 2. 

Other forms of centrality are better at measuring this impact, for example, eigenvector centrality, which will be discussed later in this literature.

```{r table-male-female-degree, fig.cap = "Average number of partners, by gender.", echo = F}
gonnet_df %>% 
  filter(nodes != "b") %>%
  group_by(gender) %>%
  summarize(average_partners = mean(partners) %>% round(3)) %>% 
  kbl(col.names = c("Gender", "Mean Number of Partners")) %>%
  kable_classic()
```

We observe from the data that on average, men have a slightly higher number of sexual partners than women in this sample.

```{r table-bar-degree, fig.cap = "Average number of partners, by bar attendance.", echo = F}
gonnet_df %>% 
  filter(nodes != "b") %>%
  group_by(attended_bar) %>%
  summarize(average_partners = mean(partners) %>% round(3)) %>% 
  kbl(col.names = c("Attended Bar", "Mean Number of Partners")) %>%
  kable_classic()
```

We further observe that those who attend the bar end up having an average of about 1.6 sexual partners compared to as many as 2.1 partners from those who did. Again, these two quantities are technically dependent (owing to the fact that these are not isolated samples, i.e. the bar attendees can be partnered with the non-attendees), so we can't formally compare them with a t-test, but it is something to take note of going forward. Later on in the literature we will bar attendance as a data attribute when developing an exponential random graph model (ERGM), in order to model this relationship, should it exist.

```{r figure-bar-degree, fig.cap = "Distribution of number of partners, by bar attendance.", echo=FALSE, warning = F}
# boxplot of degree by bar attendance
gonnet_df %>%
  filter(nodes != "b") %>%
  ggplot(aes(x = partners, fill = attended_bar)) +
  geom_histogram(binwidth = 1, position = "dodge", colour = "black", lwd = 0.75) + 
  ggtitle("Histogram of # of Partners, by Bar Attendance") +
  theme_bw() +
  scale_x_discrete("# of Partners", breaks = 0:7, labels = 0:7, limits = c(0:7)) +
  ylab("Node Count")
```

\doublespacing

Figure 4, which depicts a histogram of number of partners, colored by bar attendance, shows that a large number of non-bar patrons only have one partner; this is mostly bolstered by the fact that most of the members of the network do not frequent the bar, and also there are a sizeable number of individuals in the network who were simply alters of an ego who did attend the bar and do not have any other alters themselves.

```{r figure-gender-degree, fig.cap = "Distribution of partners, by gender.", echo=FALSE, warning = F}
# boxplot of degree by gender
gonnet_df %>%
  filter(nodes != "b") %>%
  ggplot(aes(x = partners, fill = gender)) +
  geom_histogram(binwidth =1,position = "dodge", colour = "black", lwd = 0.75) + 
  ggtitle("Histogram of # of Partners, by Gender") +
  theme_bw() + 
  scale_x_discrete("# of Partners", breaks = 0:7, labels = 0:7, limits = c(0:7)) + 
  ylab("Node Count")
```

In this case, we are a difference in the two distributions of men and women; there are many more women (10+) who had only one sexual partner in this network, with the remaining numbers between comparatively small, conversely the majority of the men are split between either one or two partners. Overall the distributions for 3 or more partners are similar across genders.

The analysis gave that the overall average degree for the directed graph is approximately 1, implying that on average individuals named one sexual partner. It's important to note that many outer edges have an degree of 0, which skews down the mean calculation somewhat. 

The implication of this observation is two-fold. For one, rather than most individuals in the network having many sexual partners, the implication of how degree is distributed in this network is that most individuals have as few as one, but there is a minority of individuals (of both genders) who named more. 

### Eigenvector Centrality

Eigenvector centrality is calculated both as a function of a node's degree but also as a function of the degree of the nodes it is connected to. In other words, a node with a high eigenvector centrality is well-connected to nodes that are themselves well-connected. 

### Katz Centrality


### Average Distance

```{r gplot-degree, echo = F, fig.cap = "Gonorrhea network, sized by degree."}
# normalizing the degree of bar because of course it has a high degree
degree_m <- cen$degree + 1
degree_m[1] <- 3

set.seed(62)

# plotting based on degree
ggnet2(gonnet_net_bar, 
       color = "gender", palette = c("M" = "lightblue", "F" = "salmon"), 
       shape = "bar", 
       mode = "fruchtermanreingold", 
       size = "partners",
       label = F)
```

```{r gplot- centralities, include = F}
# extracting the centralities that were important based on the PCA
centrality_eigen <- centralities$`eigenvector centralities`
centrality_load <- centralities$`Load Centrality`
centrality_degree <- centralities$`Degree Centrality`
centrality_geodesic <- centralities$`Geodesic K-Path Centrality`
centrality_shortest <- centralities$`Shortest-Paths Betweenness Centrality`
centrality_info <- centralities$`Information Centrality`
```

\doublespacing


## Exponential Random Graph Model (ERGM)

Exponential random graph models (ERGMs) are a family of statistical models for social networks that permit inference about prominent patterns in the data, given the presence of other network structures (Carrington and Scott, 2011). For a given set of $n$ actors, an ERGM models an observed network $x$ by assigning a probability to every network of $n$ actors, and the form of such a model is as follows

$$\Pr(X = x) = \frac{1}{k} \exp\{\sum_A \eta_Ag_A(x) \}$$
where the sum is over all configuration types $A$; 

* $\eta_A$ is a parameter correpsonding to configuration type $A$; 
* $g_A(x)$ is the _network statistic_ for $A$ and is the number of configurations $A$ observed in $x$
* $k$ normalizes this to be a proper probability distribution.

This equation implies that there is a probability distribution of all possible networks with $n$ nodes, with each such network having their own distinct probability.

The ERGM model requires a one-mode network, so we can create one by dropping the bar node from the data (while still retaining the information of bar attendance as a vertex attribute).

```{r sociogram-ggnet2-nobar, echo = F, fig.cap = "The network without the bar as a node."}
set.seed(62)
# GGally is loaded
ggnet2(gonnet_net_nobar, 
       color = "gender", palette = c("M" = "lightblue", "F" = "salmon"), 
       shape = "bar", 
       mode = "fruchtermanreingold", 
       label = F,
       size = 5)

```

Figure 3 represents the network in which the bar node is not a part of the graph; instead bar attendance is regarded as a vertex attribute in the data, as is gender. There are 7 sub-components of size greater than 2. Most interestingly is the component that comprises almost half (39) of all of the nodes in the dataset, despite containing as few as 3 bar attendees. 


\singlespacing

```{r get-aic, echo = F}
# get aic function
get_from_summary <- function(ergm_model, object) {
    
  sum <- summary(ergm_model)  
  
  if (object == "aic") {
    y <- sum$aic[1]
  }
  else if (object == "formula") {
    y <- sum$formula
  }
  
  return(y)
}

```

```{r small-ergms, echo = F, cache = T, include = F}
set.seed(55)
# library(ergm) is loaded
# simple model
ergm_model1 <- ergm(gonnet_net_nobar ~ edges)
# homophily
ergm_model2 <- ergm(gonnet_net_nobar ~ edges + nodematch("bar"))
# using symmetric model
ergm_model3 <- ergm(gonnet_net_nobar ~ edges + degree(d = c(2:3)))
# heterophily of gender
ergm_model4 <- ergm(gonnet_net_nobar ~ edges + nodemix("gender"))
# nodecov 
ergm_model5 <- ergm(gonnet_net_nobar ~ edges + nodecov("bar"))
# nodefactor
ergm_model6 <- ergm(gonnet_net_nobar ~ edges + nodefactor("bar"))
# heterophily on bar attendance
ergm_model8 <- ergm(gonnet_net_nobar ~ edges + nodemix("bar"))

ergm_model9 <- ergm(gonnet_net_nobar ~ edges + gwdegree(decay = 5, attr="bar", fixed = T))

summary(ergm_model9)
```

```{r table-model-comparison, echo = F,  results = 'hide', fig.keep = 'all'}
model_list <- list(ergm_model1, ergm_model2, ergm_model3,
                   ergm_model4, ergm_model5, ergm_model6)

aics <- sapply(model_list, FUN = get_from_summary, object = "aic")
formulas <- sapply(model_list, FUN = get_from_summary, object = "formula")

df <- matrix(data = c(formulas, aics),
              nrow = length(aics),
              ncol = 2) %>% 
  as.data.frame() %>%
  rename(formula = V1, aic = V2)

df %>% 
  kbl(caption = "Table of Akaike Information Criteria for each ERGM model") %>% 
  kable_classic()  

```

```{r ergm-model-fitting, echo = F, cache = T, include = F}
set.seed(55)
ergm_model7 <- ergm(gonnet_net_nobar ~ 
                      edges + nodemix("gender") + nodematch("bar"))
summary(ergm_model7)
model7_gof <- gof(ergm_model7, GOF = ~model)
model7_gof
# plot(model7_gof)
# mcmc.diagnostics(ergm_model7)
```

```{r ergm-model8, echo = F, cache = T, results = 'hide', fig.keep = 'all'}
set.seed(55)
ergm_model8 <- ergm(gonnet_net_nobar ~ 
                      edges + nodemix("gender") + nodematch("bar", levels = 1) + degree(d = c(2:3)))
summary(ergm_model8)
model8_gof <- gof(ergm_model8)

plot(model8_gof)
mcmc.diagnostics(ergm_model8)
```


```{r model-test}
lmtest::lrtest(ergm_model8, ergm_model7)
```

\newpage

\doublespacing

# References

De P, Singh AE, Wong T, et al. 2004. "Sexual network analysis of a gonorrhea     outbreak." *Sexually Transmitted Infections* 80:280-285.

Carrington, P. and Scott, J., 2011. *The SAGE handbook of social network          analysis. 1st ed.* Los Angeles [etc.]: SAGE Publications, pp.484-500.

  Irene A. Doherty, Nancy S. Padian, Cameron Marlow, Sevgi O. Aral, Determinants and Consequences of Sexual Networks as They Affect the Spread of Sexually Transmitted Infections, The Journal of Infectious Diseases, Volume 191, Issue Supplement_1, February 2005, Pages S42–S54, https://doi.org/10.1086/425277

Wasserman, S. and Faust, K., 1994. Social network analysis: methods and applications. Cambridge: Cambridge University Press.

\newpage

# Appendix

\singlespacing

```{r get-labels, echo = F, include = F}
labs <- knitr::all_labels()
#```{r ref.label = labs, eval = F, include = F}
#```

```

