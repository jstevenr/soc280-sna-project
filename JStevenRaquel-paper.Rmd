---
title: "Analyzing centralitty measures for a sexual network of gonorrhea transmission"
authors: 
- name: "J Steven Raquel"
- affiliation: Department of Statistics, University of California, Irvine
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(sna)
library(igraph)
library(epimdr) # for gonnet data
library(pvclust) # for pvclust()
library(CINNA) # for pca_centralities()
library(car) # for leveneTest()
library(factoextra) # for nbclust
library(cluster)
library(netdiffuseR)
data(gonnet)
source(here::here("functions.R"))
```

```{r data-prep}
# data is loaded as 'gonnet'
nodes <- rownames(gonnet)
colnames(gonnet) <- nodes

# symmetrized graph (undirected)
gonnet_sym <- symmetrize(gonnet, rule = "weak")

gonnet_df <- data.frame(nodes) %>%
  mutate(gender = ifelse(grepl("m", nodes), yes = "m", no = NA)) %>%
  mutate(gender = ifelse(grepl("f", nodes), yes = "f", no = gender)) %>%
  mutate(gender_lty = ifelse(gender == "m", yes = 4, no = 3)) %>%
  mutate(gender_lty = ifelse(gender == "f", yes = 3, no = gender_lty)) %>%
  mutate(gender_lty = ifelse(gender %in% c("m", "f"), yes = gender_lty, no = 50)
         ) %>%
  mutate(attended_bar = gonnet["b",] == 1) %>%
  mutate(col = ifelse(attended_bar == T, "tomato1", "grey"))


gonnet_df$col[!(gonnet_df$gender %in% c("m", "f"))] <- "blue"
gonnet_df$col[gonnet_df$nodes == "b"] <- "tomato1"
```

```{r sociogram}
par(mfrow = c(1,1))
set.seed(10)
org_coord <- 
  gplot(gonnet_sym, vertex.col = gonnet_df$col,
      vertex.sides = gonnet_df$gender_lty,
      # displaylabels = T, label.cex = 0.6, label.pos = 2,
      boxed.labels = F, pad = 2, usearrows = F,
      vertex.cex = 1.25)
# legend for gender
legend("topleft",
       legend = c("yes", "no"),
       col = c("tomato1", "grey"),
       fill = F, border = "white", pch = 19,
       title = "Bar Attendance", bty = "n")
legend("topright",
       legend = c("m", "f"),
       col = c("black"),
       fill = F, border = "white", pch = c(0, 2),
       title = "Gender", bty = "n")
# legend for bar attendance
title("Gonorrhea network, shaded by bar attendance")

```

```{r centrality-correlation}
cen <- get_centralities(gonnet, "directed")

# correlations between centrality measures
centrality_correlations(gonnet, cen)

cen_sym <- get_centralities(gonnet_sym, "undirected")
centrality_correlations(gonnet_sym, cen_sym)

```
Notice that outdegree and indegree are negatively correlated, which makes sense in this context; an individual will only receive gonorrhea from one person (despite possibly having multiple sexual partners with a diagnosis)

```{r centralities_more, echo = F}
# creating igraph object
gonnet_ig <- graph_from_adjacency_matrix(gonnet)

(pc <- proper_centralities(gonnet_ig)) %>% 
  capture.output() %>%
  invisible()

centralities <- calculate_centralities(gonnet_ig, 
                       include = pc[c(1, 4, 11, 16, 27, 
                                      45, 8, 18, 31, 43, 3, 19)])

# plot of different centralities' contributions via PCA
pca_centralities(centralities)

```

```{r male-female-outdegree}
gonnet_df2 <- cbind(gonnet_df, cen) %>% select(-id)

# boxplot comparing outdegree
outdegree_gender <- gonnet_df2 %>% 
  select(nodes, gender, outdegree) %>% 
  drop_na()

ggplot(outdegree_gender, aes(x=gender, y=outdegree)) + 
  geom_boxplot()

# average outdegree overall
gonnet_df2$outdegree %>% mean()

# average outdegree among males in network, overall
outdegree_m <- gonnet_df2 %>%
  select(nodes, gender, outdegree) %>%
  filter(gender == "m") %>%
  select(outdegree) %>% 
  unlist()
outdegree_m %>% mean()

# male outdegree that excludes nodes with zero outdegree
gonnet_df2 %>%
  select(nodes, gender, outdegree) %>%
  filter(gender == "m" & outdegree != 0) %>%
  select(outdegree) %>%
  unlist() %>% mean()

# average outdegree among females
outdegree_f <- gonnet_df2 %>% 
  select(nodes, gender, outdegree) %>%
  filter(gender == "f") %>% 
  select(outdegree) %>%
  unlist()
outdegree_f %>% mean()

# female outdegree that excludes nodes with zero outdegree
gonnet_df2 %>%
  select(nodes, gender, outdegree) %>%
  filter(gender == "f" & outdegree != 0) %>%
  select(outdegree) %>%
  unlist() %>% mean()

# levene test for equality of variances
# H0: the variance in outdegree between the two genders is equal
outdegree_gender$gender <- as.factor(outdegree_gender$gender)
  
leveneTest(outdegree ~ gender, 
           data = outdegree_gender)
# p-value > 0.05, so we fail to reject H0, conclude the variances are equal

# Student's t-test comparing the mean outdegree of men and women
# H0: mu_x - mu_y = 0
t.test(x = outdegree_m, 
       y = outdegree_f,
       var.equal = T, alternative = "two.sided")
# p-value = 0.5232 > 0.05, we fail to reject H0
```

```{r bar-attendance-outdegree}
# boxplot comparing distribution of outdegree between bar (not)-attended
ggplot(gonnet_df2 %>% filter(!(nodes %in% c("b", "x", "x2"))), 
       aes(x = attended_bar, outdegree)) + 
  geom_boxplot() + theme_bw()

# average outdegree among bar attendees
outdegree_bar <- gonnet_df2 %>% 
  select(nodes, attended_bar, outdegree) %>%
  filter(!(nodes %in% c("b", "x2", "x"))) %>%
  filter(attended_bar == TRUE)

# average outdegree among non-bar attendees
outdegree_nobar <- gonnet_df2 %>% 
  select(nodes, attended_bar, outdegree) %>%
  filter(!(nodes %in% c("b", "x2", "x"))) %>%
  filter(attended_bar == FALSE)

# sample sizes are unequal, so we cannot assume equal variance
# try two-sided Welch's t.test
# H0: mu_x - mu_y = 0
t.test(x = outdegree_bar$outdegree,
       y = outdegree_nobar$outdegree,
       var.equal = FALSE, alternative = "two.sided")
# p-value < 0.05, reject H0
# conclude the difference in mean outdegree is not equal to zero
```


```{r simulations, eval = F}
# simulating similar networks and determining whether than outdegree is statistically significant
mc_sim(gonnet_sym, n = 1000, alpha = 0.05, "three-cycle")
mc_sim(gonnet_sym, n = 1000, alpha = 0.05, "mutuality")
mc_sim(gonnet_sym, n = 1000, alpha = 0.05, "transitivity")
```


```{r gplot-outdegree, echo = F}
# normalizing the outdegree of bar because of course it has a high outdegree
outdegree_m <- cen$outdegree + 1
outdegree_m[1] <- 1

set.seed(10)

# plotting based on outdegree
gplot(gonnet, 
      vertex.col = gonnet_df$col,
      vertex.sides = gonnet_df$gender_lty,
      vertex.cex = outdegree_m,
      coord = org_coord)
# legend for gender
legend("topleft",
       legend = c("yes", "no"),
       col = c("tomato1", "grey"),
       fill = F, border = "white", pch = 19,
       title = "Bar Attendance", bty = "n")
legend("topright",
       legend = c("m", "f"),
       col = c("black"),
       fill = F, border = "white", pch = c(0, 2),
       title = "Gender", bty = "n")
title("Gonorrhea network, sized by outdegree")
```


## Principal Component Analysis

```{r gplot- centralities}
# extracting the centralities that were important based on the PCA
centrality_eigen <- centralities$`eigenvector centralities`
centrality_load <- centralities$`Load Centrality`
centrality_degree <- centralities$`Degree Centrality`
centrality_geodesic <- centralities$`Geodesic K-Path Centrality`
centrality_shortest <- centralities$`Shortest-Paths Betweenness Centrality`
centrality_info <- centralities$`Information Centrality`
```

```{r gplot-size-eigenvector-centrality, echo = F}
set.seed(10)

centrality_degree[1] <- 1
gplot(gonnet, vertex.col = gonnet_df$col,
      vertex.sides = gonnet_df$gender_lty,
      vertex.cex = centrality_info %>% scale(),
      # displaylabels = T, label.cex = 0.6, label.pos = 2,
      boxed.labels = F, pad = 2,
      coord = org_coord)
```

```{r find-best-cluster-number, echo = F}
# library(factoextra) is loaded
fviz_nbclust(gonnet, kmeans, method = "wss", k.max = 30)

# library(cluster) is loaded
gap_stat <- clusGap(gonnet, FUN = kmeans, nstart = 25, K.max = 30, B = 50)
fviz_gap_stat(gap_stat)
```

```{r kmeans-clustering}
km <- kmeans(gonnet, centers = 21, nstart = 25)

# fviz_cluster(km, data = gonnet_nob)

# library(netdiffuseR) is loaded
gonnet_edgelist <- adjmat_to_edgelist(gonnet, undirected = F)

# cluster_membership
km_cluster_mem <- km$cluster %>% as.data.frame() %>%
  tibble::rownames_to_column() %>%
  rename(node = 'rowname', cluster = '.')

```

```{r hierarchical-clustering, eval = F, echo = F}
set.seed(10)
par(mfrow = c(1,1))
clust <- hclust(dist(gonnet), method = "average")
# clust <- equiv.clust(gonnet)

plot(clust)
bm_complete <- blockmodel(gonnet,
                          ec = clust, k = 15)

bmR_complete <- reorder_blockmodel(bm_complete)
# overall network density, which we will use for alpha
alpha <- bmR_complete$block.model %>% mean(na.rm = T)
paste0("The mean overall network density is ", round(alpha, 3), ".")

density_matrix <- bmR_complete$block.model
# plotting blockmodel 
gplot(density_matrix > alpha,
      diag = T,
      vertex.cex = 1.5,
      label = unique(bmR_complete$block.membership),
      # boxed.labels=F,
      vertex.col="grey",
      pad = 1.25)
title("Block sociogram")

```


```{r agnes-hclust, echo = F}
set.seed(10)
par(mfrow = c(1,1))
#define linkage methods
hclust_methods <- c("average", "single", "complete", "ward")
names(hclust_methods) <- hclust_methods
#function to compute agglomerative coefficient
ac <- function(data, method) {
  agnes(data, method)$ac
}

# cluster is loaded

#calculate agglomerative coefficient for each clustering linkage method
ac_list <- list()
for (i in 1:4) {
  ac_list[[i]] <- agnes(gonnet, diss = FALSE, metric = "euclidean",
                        method = hclust_methods[i])  
  
  print(ac_list[[i]]$ac)
}
# maximum agglomerative coefficient is from the single linkage algorithm

# hclust using single and agnes
clust <- agnes(gonnet, "single", diss = F)
pltree(clust, cex = 0.6, hang = -1)
```


```{r p-value-hierarchical-clustering, cache = T}
fit <- 
  pvclust(gonnet, 
  method.hclust = "single",
  method.dist = "euclidean",
  iseed = 10, # to get same results
  parallel = T, # to use all but one CPU thread
  nboot = 1000) 
```
```{r plot-dendrogram, echo = F}
par(mfrow = c(1,1))
plot(fit)
pvrect(fit, alpha = 0.95)
```



```{r blockmodel, echo = F}
set.seed(10)
# if pchisq > 0.05, cluster is significant
pp <- pvpick(fit)
# number of significant clusters
ideal_k <- pp$clusters %>% length()

# note that these are just the "child" clusters and I want to include their parents

# blockmodel using k = 58 and cutting trees at 0.5
bm_complete <- blockmodel(gonnet,
                          ec = fit$hclust,
                          k = ideal_k, mode = "digraph")

bmR_complete <- reorder_blockmodel(bm_complete)
# overall network density, which we will use for alpha
alpha <- bmR_complete$block.model %>% mean(na.rm = T)
paste0("The mean overall network density is ", round(alpha, 3), ".")

density_matrix <- bmR_complete$block.model

par(mfrow = c(1,2))
# original plot, again
gplot(gonnet, vertex.col = gonnet_df$col,
      vertex.sides = gonnet_df$gender_lty,
      # displaylabels = T, label.cex = 0.6, label.pos = 2,
      boxed.labels = F, pad = 2, 
      vertex.cex = 1.25)
# legend for gender
legend("topleft",
       legend = c("yes", "no"),
       col = c("tomato1", "grey"),
       fill = F, border = "white", pch = 19,
       title = "Bar Attendance", bty = "n")
legend("topright",
       legend = c("m", "f"),
       col = c("black"),
       fill = F, border = "white", pch = c(0, 2),
       title = "Gender", bty = "n")
# legend for bar attendance
title("Network of gonorrhea transfer")

# plotting blockmodel 
gplot(density_matrix > alpha,
      diag = T,
      vertex.cex = 1.5,
      # label = unique(bmR_complete$block.membership),
      # boxed.labels=F,
      vertex.col="grey",
      pad = 1.25, 
      # coord = org_coord
      )
title("Block sociogram")

```



```{r plotting-fast-greedy-community, echo = F}
set.seed(10)
par(mfrow = c(1,2))
# original plot, again
org_coord <- gplot(gonnet, vertex.col = gonnet_df$col,
      vertex.sides = gonnet_df$gender_lty,
      # displaylabels = T, label.cex = 0.6, label.pos = 2,
      boxed.labels = F, pad = 2, 
      vertex.cex = 1.25,
      usearrows = F)
# legend for gender
legend("topleft",
       legend = c("yes", "no"),
       col = c("tomato1", "grey"),
       fill = F, border = "white", pch = 19,
       title = "Bar Attendance", bty = "n")
legend("topright",
       legend = c("m", "f"),
       col = c("black"),
       fill = F, border = "white", pch = c(0, 2),
       title = "Gender", bty = "n")
title("Original graph")
# adding in shape arguments for igraph to correspond to original sna gplot


# fast and greedy community detection
plot_fastgreedy_cd(gonnet, layout = org_coord, 
                   legend = F, vertex.size = 6)
title("Graph, shaded by fast-greedy community")
# labeling only the original bar patrons
```


```{r kcores, eval = F}
par(mfrow = c(1,1))
set.seed(10)
edgelist <- as.edgelist(gonnet, n = dim(gonnet)[1])
plot_kcores(edgelist, sym = F, mode = "digraph", 
            coord = org_coord,
            cmode = "outdegree")
```
