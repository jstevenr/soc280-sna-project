---
title: "A social network analysis of a gonorrhea outbreak in Alberta, Canada"
author: "J Steven Raquel"
date: "12/07/2021"
output: beamer_presentation
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, tidy=TRUE, tidy.opts=list(width.cutoff=60))
library(formatR)
library(tidyverse)
library(sna)
library(igraph)
library(epimdr) # for gonnet data
library(CINNA) # for pca_centralities()
library(car) # for leveneTest()
library(factoextra) # for nbclust
library(kableExtra) # nicer tables
library(knitr) # kable
library(ergm) # ERGMS
library(coda)
library(statnet)
library(latticeExtra)
library(GGally) # ggnet2 
library(foreign)
library(ergm.userterms)
library(Matrix)
source(here::here("functions.R"))
def.chunk.hook  <- knitr::knit_hooks$get("chunk")
knitr::knit_hooks$set(chunk = function(x, options) {
  x <- def.chunk.hook(x, options)
  paste0("\n \\", "tiny","\n\n", x, "\n\n \\normalsize")
})
```


```{r data-prep, echo = F}
# library(epimdr) is loaded
data(gonnet)
# data is loaded as 'gonnet'
nodes <- rownames(gonnet)
# indices where "x" and "x2 are
drop <- which(nodes %in% c("x", "x2"))
# drop rows/columns with these numbers
gonnet <- gonnet[-drop, -drop]
# symmetrized graph (undirected)
gonnet <- symmetrize(gonnet, rule = "weak")
nodes <- nodes[-drop]
rownames(gonnet) <- nodes
colnames(gonnet) <- nodes
# creating bar attendance vector
attended_bar <- gonnet["b", ] == 1
# creating gender vector
gender <- ifelse(grepl("m", nodes), yes = "M", no = NA)
gender <- ifelse(grepl("f", nodes), yes = "F", no = gender)

# dropping bar object from this network
gonnet_nobar <- gonnet[-1,]
gonnet_nobar <- gonnet_nobar[,-1]

# creating network object
gonnet_net_nobar <- network(gonnet_nobar, directed = F)

# adding bar attendance on graphs
network::set.vertex.attribute(gonnet_net_nobar, 'bar', attended_bar[-1])
# adding gender to the graph
network::set.vertex.attribute(gonnet_net_nobar, 'gender', gender[-1])

gonnet_bar <- gonnet
# creating igraph object
gonnet_bar_ig <- graph_from_adjacency_matrix(gonnet_bar)

(pc <- proper_centralities(gonnet_bar_ig)) %>% 
  capture.output() %>%
  invisible()

# calculating centralities for the connected graph
centralities_bar <- calculate_centralities(gonnet_bar_ig, 
                       include = pc[c(1, 4, 11, 16, 27, 
                                      45, 8, 18, 31, 43, 3, 19)])


# we care about 
# closeness centrality, katz centrality, eigenvector centrality, avg distance, degree centrality, and information centrality
degree <- sna::degree(gonnet_bar, gmode = "graph")
cen_bar <- data.frame(closeness = centralities_bar$`Closeness Centrality (Freeman)`,
                  katz = centralities_bar$`Katz Centrality (Katz Status Index)`,
                  eigenvector = centralities_bar$`eigenvector centralities`,
                  avg_distance = centralities_bar$`Average Distance`,
                  information = centralities_bar$`Information Centrality`,
                  degree)

gonnet_df <- data.frame(
  nodes,
  attended_bar,
  gender,
  degree
)

# adding partners column to dataset
gonnet_df <- gonnet_df %>% 
  mutate(partners = ifelse(attended_bar == T, yes = degree - 1, no = degree))
gonnet_df$partners[gonnet_df$nodes == "b"] <- NA

# adding partners to vertex attributes
network::set.vertex.attribute(gonnet_net_nobar, 'partners', gonnet_df$partners[-1])

# creating a network object of the two-mode network with the bar
gonnet_net_bar <- network(gonnet_bar, directed = F)

# adding gender to the graph
network::set.vertex.attribute(gonnet_net_bar, 'gender', gender)
network::set.vertex.attribute(gonnet_net_bar, 'degree', degree)

# adding a linetype attribute so that the edges to the bar are dashed lines
edgelist <- as.matrix(gonnet_net_bar, matrix.type="edgelist")
network::set.edge.attribute(gonnet_net_bar, "lty", 
                            ifelse(edgelist[,2] == 1, 2, 1))


```


## Outline

- Background
- Methods
- Discussion
- Conclusion

## Background

- This dataset concerns a localised outbreak of *Neisseria gonorrehoeae* in an indigenous community located in Alberta, Canada. it was originally analyzed in a paper by P De, et al. (2004), in which they used measures of network centrality (e.g. information centrality) to determine the association between the risk of infection between members of the network and their position within the network itself.
- The network consists of 89 individuals, both male and female, 17 of whom were found to be patrons of a local bar in the area.
- This work expands upon the original analysis by looking at other types of network centrality such as eigenvector centrality, as well as applying exponential random graph modeling (ERGM) to the network in order to quantify the effect of various attributes of the network (e.g. gender, bar attendance).

## Background

- Gonorrhea is a sexually transmitted disease/infection (STD/STI) which can be transmitted orally, vaginally or anally. 
- According to the Centers for Disease Control and Prevention, about 1 in 5 people in the United States have a STI, totalling nearly 68 million infections in 2018.
- Of the 26 million new infections in 2018, it is estimated about 1.6 million of them were gonorrhea. 
- Although it can have many serious side effects, it can also be symptomless, leading to individuals unknowingly infecting their partners. 

## Background

- Although the adjacency matrix for the data allowed us to analyze the network as a directed network, we thought it prudent to symmetrize the matrix (as was done in P De et al.)   
- 2 of the datapoints were missing information regarding their gender so we dropped them from the dataset. They both had a degree of 1 so it wasn't thought that their exclusion would be impactful. This left 46 males and 46 females in the network.

## Background

- Data on sexual networks can be collected either egocentrically or sociometrically. 
- In the former case, the method involves interviewing the ego, and getting information regarding their alters (sexual partners) without in turn contacting their alters. 


# On studying sexual networks 

## The connected network with the bar as a node

```{r sociogram-bar}
# GGally is loaded
set.seed(62)
ggnet2(gonnet_net_bar,
       color = "gender", 
       palette = c("F" = "#F8766D", "M" = "#00BFC4", "NA" = "grey"),
       mode = "fruchtermanreingold",
       label = F,
       edge.lty = "lty", 
       size = 5)
```


## The connected network with the bar as a node 

- There are 91 total edges in this network, with 17 of them being between the bar and individuals, leaving 74 of them to be between individuals.
- Of these 74, 67 (approx. 90.5%) of them are M-F edges, 6 of them are M-M, and 1 of them is F-F.
- Of these 74, 36 (approx. 48.6%) of them are between bar-attendees and non-attendees, and 38 (51.3%) are between non-attendees and other non-attendees only.
- Note that none of the bar attendees have ties to other bar attendees at all.

## Distribution of ties

```{r figure-gender-degree-histogram, fig.cap = "Histogram of partners, by gender.", echo=FALSE, warning = F}
# boxplot of degree by gender
gonnet_df %>%
  filter(nodes != "b") %>%
  ggplot(aes(x = partners, fill = gender)) +
  geom_histogram(binwidth =1,position = "dodge", colour = "black", lwd = 0.75) + 
  ggtitle("Histogram of # of Partners, by Gender") +
  theme_bw() + 
  scale_x_discrete("# of Partners", breaks = 0:7, labels = 0:7, limits = c(0:7)) + 
  ylab("Node Count")
```

- Note that the distribution in number of partners is more right skewed for women than it is for men, owing to the fact that about a third of more women in this network had 1 partner compared to men who had 1 partner. 
- Generally men's number of partners is more spread between 1-2 partners. 
- The distribution is similar for both genders when looking at those having more than 2 partners. 


## Methods

- Degree Centrality
- Eigenvector Centrality
- Katz Centrality
- Average Distance
- Exponential Random Graph Model (ERGM)


## Exponential Random Graph Model (ERGM)

- While measures such as network centrality and network density can provide us some information about the characteristics of a network, in the case of a sexual network in which ties have an explicitly social component to them, an ERGM which incorporates the attributes of actors within the network can be more informative.
- ERGMs model networks as a function of network statistics, by imagining the network as one instance of a set of possible, similar networks, i.e. the outcomes of a stochastic (random) process. 


## Exponential Random Graph Model (ERGM)
- When modeling the ERGM for this network, the bar node was redacted so that the network could be a one-mode network, and instead attendance of the bar was assigned to the vertices as an attribute, as was gender. This model was saved as `gonnet_net_nobar` in `R`.

## The disconnected network

```{r sociogram-nobar}
set.seed(62)
# GGally is loaded
ggnet2(gonnet_net_nobar, 
       color = "gender", 
       palette = c("F" = "#F8766D", "M" = "#00BFC4"), 
       shape = "bar", 
       mode = "fruchtermanreingold", 
       label = F,
       size = 5)
```

## The disconnected network

- There are about 9 or so subcomponents of this graph; notice that the largest among them has 3 bar attendees within it, 2 of whom have at least 5 ties to other individuals. 
- Notice there is one isolate where a male node attended the bar but otherwise has no ties to any other node. 
- There also a a series of smaller sub-components where there is only one edge between two nodes, one of whom is a bar attendee. 
- Note the presence of a "6-cycle" in the largest subcomponent, in which 6 separate nodes are jointly connected through one another. This is the only such appearance of a k-cycle in the entire network. 
- The largest subcomponent of the graph includes 38 of the 86 nodes in the network, or approximately 44% of all egos. 

## Fitting the ERGM model

- When fitting the ERGM model, first we started with the simplest model that only models the number of edges (this would be akin to an intercept-only model in logistic regression). We then built several more models which only had one parameter, and then compared the Akaike Information Criteria (AIC) of the models to determine which among these model parameters were worth including. 
- Among the model parameters fit were homophily (`nodematch`), heterophily (`nodemix`) and degree (`degree`). 

```{r fitting-ergms-run, include = F}
set.seed(55)
# library(ergm) is loaded
# simple model
ergm_model1 <- ergm(gonnet_net_nobar ~ edges)
# homophily
ergm_model2 <- ergm(gonnet_net_nobar ~ edges + 
                nodematch("bar"))
# using symmetric model
ergm_model3 <- ergm(gonnet_net_nobar ~ edges + 
                degree(d = c(1:3)))
# heterophily of gender
ergm_model4 <- ergm(gonnet_net_nobar ~ edges + 
                nodemix("gender"))
# nodefactor
ergm_model5 <- ergm(gonnet_net_nobar ~ edges + 
                nodefactor("bar"))
# heterophily on bar attendance
ergm_model6 <- ergm(gonnet_net_nobar ~ edges + 
                nodemix("bar"))
```

## Akaike Information Criterion (AIC)

- The Akaike Information Criterion (AIC) is an estimator of out-of-sample prediction error.
- We use it as a means of model selection, where we generally opt to select the model with the lowest AIC.
- $$AIC = -2 \ln(L) + 2k$$
- Where $L$ is the likelihood of the model, and $k$ is the number of parameters.

## Fitting the ERGM model

```{r table-model-comparison, echo = F}
model_list <- list(ergm_model1, ergm_model2, ergm_model3,
                   ergm_model4, ergm_model5, ergm_model6)
# get_from_summary() is from functions.R
aics <- sapply(model_list, FUN = get_from_summary, object = "aic")
formulas <- sapply(model_list, FUN = get_from_summary, object = "formula")

df <- matrix(data = c(formulas, aics),
              nrow = length(aics),
              ncol = 2) %>% 
  as.data.frame() %>%
  rename(formula = V1, aic = V2)

df %>% 
  kbl(caption = "Table of Akaike Information Criteria for each ERGM model") %>% 
  kable_classic()  
```

```{r ergm_model7, echo = F}
set.seed(5)
ergm_model7 <- quietly(ergm)(gonnet_net_nobar ~ 
                      edges + 
                      degree(d = c(1:3)) + 
                      nodemix("gender"))

ergm_model7 <- ergm_model7$result
```

```{r ergm_model8, echo = F}
set.seed(5)
ergm_model8 <- quietly(ergm)(gonnet_net_nobar ~ 
                      edges + 
                      degree(d = c(1:3)) + 
                      nodemix("gender") + 
                      nodematch("bar")) 

ergm_model8 <- ergm_model8$result
```

```{r }
ergm(gonnet_net_nobar ~  edges + degree(d = c(1:3)) + nodemix("gender") + 
                      nodematch("bar")) 

```

## Likelihood Ratio Testing

- A likelihood ratio test is a method to compare a full model to a nested model, where the nested model has some subset of the same parameters as the full model.
- When comparing a full model to a nested model, we can conduct a Likelihood Ratio Test, in which we take the ratio of the maximum likelihoods of both the full model and the nested model, in order to determine whether the nested model explains the data as well as the full model.

## Likelihood Ratio Testing

- $\lambda = \frac{\mathcal{L}_s (\hat \theta)}{\mathcal{L}_g (\hat \theta)}$
- $\text{LRT} = -2 \ln \lambda$
- where $\mathcal{L}_s (\hat \theta)$ is the maximized log-likelihood for the nested model, and $\mathcal{L}_g$ is the maximized log-likelihood for the full model.

## Likelihood Ratio Testing

- $H_0$: The nested model fits the data as well as the full model. i.e. The nested model is preferred.
- $H_A$: The nested model does not fit the data as well as the full model. i.e. The full model is preferred.
- We reject the null hypothesis $H_0$ when the test statistic falls within the rejection region of a chi-squared distribution with degrees of freedom $k$ where $k$ is the difference in the number of parameters between the two models. Otherwise, we fail to reject $H_0$. 


## Likelihood Ratio Testing

```{r lrtest}
set.seed(5)
lmtest::lrtest(ergm_model8, ergm_model7)
```

## Model Selection

- The chi-squared test statistic for the likelihood ratio test had a p-value of $\approx 0.002$, which is less than our significance level $\alpha = 0.05$. 
- Hence we have enough evidence to reject the null hypothesis and conclude that full model, which has the homophily attribute for bar attendance in addition to the heterophily attribute for gender and the degree attribute, is the preferred model.

## Markov Chain Monte Carlo (MCMC)
- 


## Model Diagnostics

```{r model-diagnostics}
summary(ergm_model8)
model8_gof <- gof(ergm_model8, GOF = ~ model)
# goodness of fit for model statistics
model8_gof$pval.model


```

## Plotting Goodness of Fit

```{r goodness-of-fit}
plot(model8_gof)
```

## MCMC Diagnostics
```{r mcmc-diagnostics, echo = F}
mcmc.diagnostics(ergm_model8)
```

## Model Interpretation